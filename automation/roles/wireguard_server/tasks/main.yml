---
# Install required packages
- name: Install WireGuard and dependencies
  ansible.builtin.apt:
    update_cache: true
    name:
      - wireguard
      - iptables
      - iptables-persistent
    state: present

# Ensure WireGuard directory exists
- name: Ensure /etc/wireguard exists
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    owner: root
    group: root
    mode: "0700"

# Detect default LAN interface if not explicitly set
- name: Detect default LAN interface
  ansible.builtin.shell: |
    set -e
    ip route show default | awk '{print $5; exit}'
  args:
    executable: /bin/bash
  register: default_iface
  changed_when: false
  when: wg_lan_iface | length == 0

- name: Set LAN interface fact
  ansible.builtin.set_fact:
    lan_iface: "{{ (wg_lan_iface | length > 0) | ternary(wg_lan_iface, default_iface.stdout) }}"

# Enable IPv4 forwarding
- name: Enable IPv4 forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: true
  when: wg_enable_forwarding

# Check if WireGuard server private key exists
- name: Check for existing server private key
  ansible.builtin.stat:
    path: /etc/wireguard/server.key
  register: server_key_stat

# Generate server private key (first run only)
- name: Generate WireGuard server private key
  ansible.builtin.shell: |
    set -e
    umask 077
    wg genkey | tee /etc/wireguard/server.key > /dev/null
  args:
    executable: /bin/bash
  when: not server_key_stat.stat.exists

# Ensure correct permissions on private key
- name: Set permissions on server private key
  ansible.builtin.file:
    path: /etc/wireguard/server.key
    owner: root
    group: root
    mode: "0600"

# Generate server public key (first run only)
- name: Generate WireGuard server public key
  ansible.builtin.shell: |
    set -e
    wg pubkey < /etc/wireguard/server.key > /etc/wireguard/server.pub
  args:
    executable: /bin/bash
  when: not server_key_stat.stat.exists

# Read server private key from remote host (securely)
- name: Read server private key
  ansible.builtin.slurp:
    src: /etc/wireguard/server.key
  register: server_key_slurp
  no_log: true

# Set private key as a fact for templating
- name: Set WireGuard server private key fact
  ansible.builtin.set_fact:
    wg_server_private_key: "{{ server_key_slurp.content | b64decode | trim }}"
  no_log: true

- name: Manage WireGuard peers (keys + client configs)
  ansible.builtin.include_tasks: peers.yml
  when: wg_peers is defined and (wg_peers | length) > 0


# Render WireGuard configuration (server only, no peers yet)
- name: Render wg0.conf
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: "/etc/wireguard/{{ wg_interface }}.conf"
    owner: root
    group: root
    mode: "0600"
  notify: Restart WireGuard

# Enable and start WireGuard
- name: Enable and start WireGuard
  ansible.builtin.systemd:
    name: "wg-quick@{{ wg_interface }}"
    enabled: true
    state: started
